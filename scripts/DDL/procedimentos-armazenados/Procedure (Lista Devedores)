CREATE PROCEDURE sp_Clientes_Inadimplentes_Resumo
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        c.id_cliente,
        c.nome,
        c.email,
        c.telefone,
        COUNT(p.id_pagamento) AS qtde_parcelas_vencidas,
        SUM(p.valor_pago) AS valor_total_vencido,
        STRING_AGG(DISTINCT ap.status_apolice, ', ') AS status_apolices
    FROM Clientes c
    INNER JOIN Aparelhos a ON c.id_cliente = a.id_cliente
    INNER JOIN Apolices ap ON a.id_aparelho = ap.id_aparelho
    INNER JOIN Pagamentos p ON ap.id_apolice = p.id_apolice
    WHERE 
        p.data_vencimento < GETDATE()
        AND p.status_pagamento = 'Em aberto'
    GROUP BY 
        c.id_cliente, c.nome, c.email, c.telefone
    HAVING COUNT(p.id_pagamento) > 0
    ORDER BY valor_total_vencido DESC;
END;

EXEC sp_Clientes_Inadimplentes_Resumo;
